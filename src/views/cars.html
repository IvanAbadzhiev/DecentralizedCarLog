 <% include header %>
		<div class="jumbotron">
		  <h1 class="display-4">Add a car</h1>
		  <p class="lead">You can add your car on blockchain</p>
		  <hr class="my-4">
		  <form>
		  <p>
		  	<div class="form-group">
			    <label for="name">Car vin : </label>
			    <input type="text" class="form-control" id="name" name="name" placeholder="Your Service ltd">
			    <span class="success"></span>
			    <span class="error"></span>
		  	</div>

		  	<div class="form-group">
			    <label for="name">Car Image : </label>
			    <input type="file" class="form-control" id="carImage">
			    <input type="hidden" id="ipfsImage">
			    <span class="error"></span>
		  	</div>
		  </p>
		  <p class="lead">
		    <input type="button" class="btn btn-primary btn-lg" id="addAcar" value="Add a vehicle!">
		  </p>
		  </form>
		</div>
		

		<div class="row" id="carRow">
			<!-- here will be added all available services -->
		</div>
	</div>
	<script>
	let carContractAddress = '0x86758e8488c649ae7b9245272eabd4b81ff373e6';
	let carContractAbi = [{"constant":!0,"inputs":[{"name":"_vin","type":"string"}],"name":"getRepairsCount","outputs":[{"name":"","type":"uint256"}],"payable":!1,"stateMutability":"view","type":"function"},{"constant":!0,"inputs":[{"name":"_vin","type":"string"},{"name":"index","type":"uint256"}],"name":"getRepair","outputs":[{"name":"","type":"address"},{"name":"","type":"string"},{"name":"","type":"uint256"}],"payable":!1,"stateMutability":"view","type":"function"},{"constant":!0,"inputs":[],"name":"getMyCarsCount","outputs":[{"name":"","type":"uint256"}],"payable":!1,"stateMutability":"view","type":"function"},{"constant":!0,"inputs":[{"name":"index","type":"uint256"}],"name":"getMyCar","outputs":[{"name":"","type":"string"},{"name":"","type":"string"}],"payable":!1,"stateMutability":"view","type":"function"},{"constant":!0,"inputs":[{"name":"_vin","type":"string"}],"name":"getCarByVin","outputs":[{"name":"","type":"string"}],"payable":!1,"stateMutability":"view","type":"function"},{"constant":!1,"inputs":[{"name":"_vin","type":"string"},{"name":"image","type":"string"}],"name":"addCar","outputs":[],"payable":!1,"stateMutability":"nonpayable","type":"function"},{"constant":!1,"inputs":[{"name":"_vin","type":"string"},{"name":"_repair","type":"string"}],"name":"addRepair","outputs":[],"payable":!1,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":!1,"stateMutability":"nonpayable","type":"constructor"}];

	web3.eth.defaultAccount = web3.eth.accounts[0];

	let carContract = web3.eth.contract(carContractAbi).at(carContractAddress)

	function addACar(name, image){
		$('.success').val('');

		carContract.addCar(name,image, function(err, result) {
			if(!err) { 
				$('.success').append("Success: Your car will be in the blockchain soon, you can check your transaction <a target=\"blank\" href='https://ropsten.etherscan.io/tx/" + result + "'>here</a>");
			} else {
				console.log(err);
			}
		});
	}

	function getCars(){
		carContract.getMyCarsCount(function(err, data){
			
			if(!err) {
				let carsCount = data.toNumber();
				
				for (var i = 0; i < carsCount; i++) {
				
					carContract.getMyCar(i, function(err, result){
						let vin = result[0];
						let image = result[1];

						let html = '<div class="col-sm-6 col-md-4 col-lg-3">';
	    				html += '<div class="panel panel-default">';
	    				html += '<div class="panel-heading">';
	    				html += '<h3 class="panel-title">' + vin + '</h3>';
	    				html += '</div>'

	    				html += '<div class="panel-body">';
	    				html += '<img style="width: 100%;" src="' + image + '">';
	    				html += '<br/><br/>';
	    				html += '<strong>Change Ownership</strong>: <br/>';
	    				html += '<strong>Address</strong>: <input type="text" class="form-control"><br/>';
	    				html += '<button class="btn btn-default" type="button" data-id="' + '' + '">Change</button>';
	    				html += '</div>';
	    				html += '</div>';
	    				html += '</div>';

	    				$('#carRow').append(html);
					});
				}
			} else {
				console.log(err);
			}
		});
	}

	$("#addAcar").on("click", function(){
		const reader = new FileReader();
      	
      	reader.onloadend = function() {
	        const ipfs = window.IpfsApi('ipfs.infura.io', '5001', {protocol: 'https'})
	        const buf = buffer.Buffer(reader.result) // Convert data into buffer
	        
	        let upload = {
	        	"path" : "attributes.json",
	        	"content" : buf
	        }
	        
	        $(".loading").show();
	        
	        ipfs.files.add([upload], (err, result) => { // Upload buffer to IPFS
	          if(err) {
	            console.error(err)
	            return
	          }
	          let url = `https://ipfs.io/ipfs/${result[0].hash}`

	         $("#ipfsImage").val(url);
	         $(".loading").hide();
	        });
	    }
        
        const carImage = document.getElementById("carImage");
        reader.readAsArrayBuffer(carImage.files[0]); // Read Provided File

		$(".error").text('');

		let carName = $("#name").val();

		if(!carName){
    		$(".error").text('Please write valid car vin');
    		return;
    	} 

    	if(carName.length !== 17){
    		$(".error").text('Service name must be 17 characters');
    		return;
    	}

    	let image = $("#ipfsImage").val();

    	if(!image){
    		$(".errorImage").text('Please add image of your car');
    	}
    	
    	addACar(carName,image);

	});

	$(document).ready(function() {
		getCars();
	});
	</script>
 <% include footer %>